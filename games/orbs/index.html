<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Backyard Orbs — 2.2 (Mobile Polish)</title>
<style>
  html,body{height:100%;margin:0;background:#0b0f14;color:#e6f0ff;font-family:Arial,Helvetica,sans-serif; overscroll-behavior: none;}
  #wrap{display:flex;flex-direction:column;height:100%}
  header{padding:10px 12px;display:flex;gap:8px;align-items:center;background:#101722;border-bottom:1px solid #243140; padding-top: calc(10px + env(safe-area-inset-top));}
  .btn{padding:10px 14px;border:1px solid #2a3a4a;background:#121a22;color:#e6f0ff;border-radius:10px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .stat{padding:6px 8px;border:1px solid #243140;background:#0e141b;border-radius:6px;font-variant-numeric:tabular-nums; font-size: clamp(12px, 2.6vw, 14px);}
  canvas{display:block;width:100%;height:100%; touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;}

  /* Start (Primer) */
  #title {
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center; flex-direction:column;
    background:
      linear-gradient(rgba(11,15,20,0.85), rgba(11,15,20,0.85)),
      url('enoch.png') center/cover no-repeat;
    backdrop-filter: saturate(120%) blur(2px);
  }
  #card{width:min(92%,780px);border:1px solid #243140;background:#0e141b;padding:16px 14px 18px;border-radius:12px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.35)}
  #card h1 { font-size: clamp(20px, 6vw, 28px); }
  .mono{font-variant-numeric:tabular-nums}

  /* Overlay (used by win & lose) */
  #cinOverlay{position:absolute;inset:0;pointer-events:none;display:none}
  #cinOverlay .center{position:absolute;left:50%;top:78%;transform:translate(-50%,-50%);width:min(92%,820px);text-align:center}
  #cinOverlay .title{font-size:28px;letter-spacing:6px;color:#eaf4ff;text-shadow:0 0 16px rgba(150,210,255,.6);opacity:.95}
  #cinOverlay .verses{margin-top:14px;color:#eaf4ff;text-shadow:0 0 10px rgba(180,220,255,0.55);font-size:18px;line-height:1.35}
  #cinOverlay .hint{color:#9fb6cc;font-size:12px;margin-top:8px}
  #cinOverlay .btnRow{margin-top:16px;display:flex;gap:10px;justify-content:center}

  /* Top-right placement for lose overlay */
  #cinOverlay .center.topRight{
    left: auto;
    right: 6%;
    top: calc(24% + env(safe-area-inset-top));
    transform: translate(0,-50%);
    text-align: right;
    width: min(92%, 520px);
  }
  @media (max-width: 480px){
    #cinOverlay .center.topRight{
      right: 4%;
      top: calc(22% + env(safe-area-inset-top));
      width: min(92%, 420px);
    }
  }
</style>
</head>
<body>
<div id="wrap">
  <header>
    <button id="startBtn" class="btn">Play</button>
    <button id="pauseBtn" class="btn" disabled>Pause</button>
    <button id="resetBtn" class="btn" disabled>Reset</button>
    <div class="stat">Score: <span id="scoreEl">0</span></div>
    <div class="stat">Time: <span id="timeEl">60.0</span>s</div>
    <div class="stat">Hits: <span id="hitsEl">0</span> Misses: <span id="missesEl">0</span></div>
    <div class="stat">Goal: <span id="goalEl">1500</span></div>
  </header>

  <!-- Primer -->
  <div id="title">
    <div id="card">
      <h1 style="margin:6px 0 4px;">Backyard Orbs</h1>
      <p style="margin:6px 0 10px;color:#cfe6ff"><em>Night watch. Signs in the heavens.</em></p>
      <p style="margin:6px 0 6px">
        <span style="color:#9fe2ff">Blue orbs</span> are living lights — keepers of truth.<br>
        <span style="color:#ff9aa0">Red drones</span> are deceivers — fallen watchers and their toys.
      </p>
      <p style="margin:0 0 10px">Shine your beam, gather truth, avoid the counterfeit. Reach <strong>1500</strong> before dawn.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0 8px" class="mono">
        <span class="stat">Aim: mouse/touch</span>
        <span class="stat">Beam: hold</span>
      </div>
      <button id="tPlay" class="btn" style="min-width:220px;margin-top:6px">Start Night Watch</button>
    </div>
  </div>

  <canvas id="game"></canvas>

  <!-- Cinematic overlay UI (titles + lines + play again) -->
  <div id="cinOverlay">
    <div class="center">
      <div id="cinTitle" class="title">ENOCH</div>
      <div id="verses" class="verses"></div>
      
      <div class="btnRow"><button id="againBtn" class="btn" style="pointer-events:auto;display:none">Play Again</button></div>
    </div>
  </div>
</div>

<script>
(function(){
  // ===== canvas & utils =====
  const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
  const DPR=()=>window.devicePixelRatio||1;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(a,b)=>a+Math.random()*(b-a);
  const lerp=(a,b,t)=>a+(b-a)*t;
  const easeInOut=(t)=>t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
  function resize(){const d=DPR();canvas.width=Math.floor(canvas.clientWidth*d);canvas.height=Math.floor(canvas.clientHeight*d);ctx.setTransform(d,0,0,d,0,0)}
  new ResizeObserver(resize).observe(canvas); resize();

  // ===== UI refs =====
  const titleEl=document.getElementById('title');
  const startBtn=document.getElementById('startBtn'), tPlay=document.getElementById('tPlay');
  const pauseBtn=document.getElementById('pauseBtn'), resetBtn=document.getElementById('resetBtn');
  const scoreEl=document.getElementById('scoreEl'), timeEl=document.getElementById('timeEl');
  const hitsEl=document.getElementById('hitsEl'), missesEl=document.getElementById('missesEl'), goalEl=document.getElementById('goalEl');
  const overlay=document.getElementById('cinOverlay'), titleText=document.getElementById('cinTitle'), versesBox=document.getElementById('verses'), againBtn=document.getElementById('againBtn');
  const overlayCenter = overlay.querySelector('.center');

  // ===== defaults (toggles removed) =====
  let SFX_ENABLED=true;
  let REDUCED_MOTION=false;
  if (Math.min(window.innerWidth, window.innerHeight) < 420) REDUCED_MOTION = true;

  // ===== audio (simple) =====
  let actx; const audio=()=>actx||(actx=new (window.AudioContext||window.webkitAudioContext)());
  const tone=(f=440,d=.12,t='sine',v=.15)=>{if(!SFX_ENABLED) return; const a=audio(),o=a.createOscillator(),g=a.createGain();o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g).connect(a.destination);const T=a.currentTime;o.start(T);g.gain.exponentialRampToValueAtTime(1e-4,T+d);o.stop(T+d+.02)};
  const chirp=(a,b,d)=>{if(!SFX_ENABLED) return; const A=audio(),o=A.createOscillator(),g=A.createGain();o.type='triangle';o.frequency.setValueAtTime(a,A.currentTime);o.frequency.exponentialRampToValueAtTime(b,A.currentTime+d);g.gain.value=.15;o.connect(g).connect(A.destination);o.start();g.gain.exponentialRampToValueAtTime(1e-4,A.currentTime+d);o.stop(A.currentTime+d+.01)};
  const sfx={ orb:()=>chirp(900,1500,.12), drone:()=>tone(180,.18,'sawtooth',.18), bark:()=>{tone(450,.06,'square',.22);setTimeout(()=>tone(300,.08,'square',.2),70)}, win:()=>{chirp(600,1600,.2);setTimeout(()=>chirp(700,1800,.25),150);setTimeout(()=>tone(1200,.25,'sine',.12),350)}, lose:()=>{tone(110,.18,'sawtooth',.2);setTimeout(()=>tone(80,.22,'sawtooth',.22),140)} };

  // ===== state =====
  const SETTINGS={timeStart:60,goal:1500,max:20,droneChance:.35};
  const STATE={running:false,paused:false,ended:false,timeLeft:SETTINGS.timeStart,score:0,hits:0,misses:0,streak:0,last:0,t:0,mode:'play'};
  goalEl.textContent=SETTINGS.goal;

  // ===== input =====
  const input={aiming:false,pointer:{x:0,y:0}};
  function pt(e){const r=canvas.getBoundingClientRect();return {x:(e.clientX||e.touches[0].clientX)-r.left, y:(e.clientY||e.touches[0].clientY)-r.top};}
  canvas.addEventListener('mousemove',e=>{const p=pt(e);input.pointer=p});
  canvas.addEventListener('mousedown',()=>input.aiming=true);
  canvas.addEventListener('mouseup',()=>input.aiming=false);
  canvas.addEventListener('touchstart',e=>{e.preventDefault();input.aiming=true;input.pointer=pt(e)},{passive:false});
  canvas.addEventListener('touchmove',e=>{e.preventDefault();input.pointer=pt(e)},{passive:false});
  canvas.addEventListener('touchend',e=>{e.preventDefault();input.aiming=false},{passive:false});

  // ===== background image =====
  const bgImg=new Image(); bgImg.src="background.jpg";

  // ===== particles =====
  const particles=[];
  class Particle{constructor(x,y,dx,dy,life,clr,glow=[255,255,255],size=2){this.x=x;this.y=y;this.dx=dx;this.dy=dy;this.life=life;this.max=life;this.clr=clr;this.glow=glow;this.size=size}
    update(dt){this.life-=dt;this.x+=this.dx*dt;this.y+=this.dy*dt}
    draw(ctx){if(this.life<=0)return;const a=Math.max(0,this.life/this.max);ctx.save();ctx.globalCompositeOperation='lighter';const g=ctx.createRadialGradient(this.x,this.y,this.size*.5,this.x,this.y,this.size*3);g.addColorStop(0,`rgba(${this.glow[0]},${this.glow[1]},${this.glow[2]},${a*.7})`);g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(this.x,this.y,this.size*3,0,Math.PI*2);ctx.fill();ctx.restore();ctx.fillStyle=`rgba(${this.clr[0]},${this.clr[1]},${this.clr[2]},${a})`;ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();}}

  // ===== entities =====
  class Orb{constructor(){this.kind='orb';this.r=8+Math.random()*10;this.x=Math.random()*canvas.clientWidth;this.y=10+Math.random()*(canvas.clientHeight*.4);this.vx=(Math.random()*2-1)*40;this.vy=(Math.random()*2-1)*20;this.t=Math.random()*6.28;this.alive=true}
    update(dt){this.t+=dt;this.x+=this.vx*dt;this.y+=(Math.sin(this.t*2)*20+this.vy)*dt;if(this.x<this.r||this.x>canvas.clientWidth-this.r)this.vx*=-1;this.y=clamp(this.y,this.r+6,canvas.clientHeight*.5);if(Math.random()<.06 && !REDUCED_MOTION){particles.push(new Particle(this.x+rand(-1,1),this.y+rand(-1,1),rand(-6,6),rand(-6,6),.4,[220,245,255],[140,220,255],1.7))}}
    draw(ctx){ctx.save();ctx.globalCompositeOperation='lighter';const g=ctx.createRadialGradient(this.x,this.y,2,this.x,this.y,this.r*2.2);g.addColorStop(0,'rgba(150,220,255,1)');g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(this.x,this.y,this.r*2.2,0,Math.PI*2);ctx.fill();ctx.restore();ctx.fillStyle='rgba(240,255,255,.95)';ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill()} getCircle(){return{x:this.x,y:this.y,r:this.r}}}
  class Drone{constructor(){this.kind='drone';this.w=34;this.h=16;this.r=16;this.x=Math.random()*canvas.clientWidth;this.y=canvas.clientHeight*.2+Math.random()*canvas.clientHeight*.3;const s=50+Math.random()*60;this.vx=(Math.random()<.5?-1:1)*s;this.t=Math.random()*6.28;this.alive=true}
    update(dt){this.t+=dt;this.x+=this.vx*dt;this.y+=Math.sin(this.t*3)*10*dt;if(this.x<0||this.x>canvas.clientWidth)this.vx*=-1;this.y=clamp(this.y,canvas.clientHeight*.18,canvas.clientHeight*.55)}
    draw(ctx){const p=1+.25*Math.sin(this.t*6);ctx.save();ctx.globalCompositeOperation='lighter';const g=ctx.createRadialGradient(this.x,this.y,2,this.x,this.y,this.r*1.8*p);g.addColorStop(0,'rgba(255,50,50,.5)');g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.beginPath();ctx.arc(this.x,this.y,this.r*1.8*p,0,Math.PI*2);ctx.fill();ctx.restore();ctx.save();ctx.translate(this.x,this.y);ctx.fillStyle='#9aa9b6';ctx.fillRect(-this.w/2,-this.h/2,this.w,this.h);ctx.fillStyle='#233649';ctx.beginPath();ctx.arc(0,0,4,0,Math.PI*2);ctx.fill();ctx.restore()} getCircle(){return{x:this.x,y:this.y,r:this.r}}}

  const entities=[];

  // ===== player =====
  const player={ x:0,y:0,w:34,h:64, hand:{x:0,y:0}, get feetY(){return canvas.clientHeight-36} };
  function solveArm(sx,sy,tx,ty,up=16,fo=16){ const dx=tx-sx,dy=ty-sy; let d=Math.hypot(dx,dy); const m=up+fo; const ux=dx/(d||1),uy=dy/(d||1); d=Math.min(d,m-0.5); const ex=sx+ux*up, ey=sy+uy*up; const hx=sx+ux*d, hy=sy+uy*d; return {ex,ey,hx,hy}; }
  function drawPlayer(){
    const x=player.x,y=player.y; ctx.save(); ctx.translate(x,y);
    // legs
    ctx.fillStyle='#4b6da0'; ctx.fillRect(6,player.h-18,8,18); ctx.fillRect(player.w-14,player.h-18,8,18);
    // torso
    ctx.fillStyle='#6ea3ff'; ctx.fillRect(2,14,player.w-4,player.h-26);
    // head
    ctx.fillStyle='#e8c39e'; ctx.beginPath(); ctx.arc(player.w/2,6,12,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#0b0f14'; ctx.fillRect(player.w/2-6,4,3,3); ctx.fillRect(player.w/2+3,4,3,3);
    // arms
    const lsx=player.w*0.28, lsy=22; const rsx=player.w*0.88, rsy=22;
    const arm=solveArm(lsx,lsy,input.pointer.x-x,input.pointer.y-y,17,17); player.hand.x=arm.hx+x; player.hand.y=arm.hy+y;
    ctx.lineCap='round';
    ctx.strokeStyle='#e8c39e'; ctx.lineWidth=6; ctx.beginPath(); ctx.moveTo(lsx,lsy); ctx.lineTo(arm.ex,arm.ey); ctx.lineTo(arm.hx,arm.hy); ctx.stroke();
    ctx.strokeStyle='#cfae82'; ctx.lineWidth=3.5; ctx.beginPath(); ctx.moveTo(lsx,lsy); ctx.lineTo(arm.ex,arm.ey); ctx.lineTo(arm.hx,arm.hy); ctx.stroke();
    // right (rest)
    ctx.strokeStyle='#e8c39e'; ctx.lineWidth=6; ctx.beginPath(); ctx.moveTo(rsx,rsy); ctx.lineTo(rsx+1,rsy+14); ctx.lineTo(rsx+1,rsy+30); ctx.stroke();
    ctx.strokeStyle='#cfae82'; ctx.lineWidth=3.5; ctx.beginPath(); ctx.moveTo(rsx,rsy); ctx.lineTo(rsx+1,rsy+14); ctx.lineTo(rsx+1,rsy+30); ctx.stroke();
    ctx.restore();
  }

  // ===== helpers =====
  const lineHitsCircle=(x1,y1,x2,y2,cx,cy,r)=>{const vx=x2-x1,vy=y2-y1,wx=cx-x1,wy=cy-y1,v2=vx*vx+vy*vy||1e-6,t=Math.max(0,Math.min(1,(wx*vx+wy*vy)/v2)),px=x1+t*vx,py=y1+t*vy,dx=px-cx,dy=py-cy;return dx*dx+dy*dy<=r*r};

  // ===== flow =====
  function startGame(){try{audio().resume()}catch{} STATE.running=true;STATE.paused=false;STATE.ended=false;STATE.mode='play';STATE.timeLeft=SETTINGS.timeStart;STATE.score=0;STATE.hits=0;STATE.misses=0;STATE.streak=0;entities.length=0;particles.length=0;player.x=(canvas.clientWidth - player.w)/2;player.y=player.feetY-player.h;titleEl.style.display='none';pauseBtn.disabled=false;resetBtn.disabled=false;overlay.style.display='none';versesBox.innerHTML='';againBtn.style.display='none';}
  function togglePause(){if(!STATE.running||STATE.mode!=='play')return;STATE.paused=!STATE.paused;pauseBtn.textContent=STATE.paused?'Resume':'Pause'}
  function resetGame(){STATE.running=false;STATE.paused=false;STATE.ended=false;STATE.mode='play';titleEl.style.display='flex';pauseBtn.disabled=true;resetBtn.disabled=true;pauseBtn.textContent='Pause';overlay.style.display='none';versesBox.innerHTML='';againBtn.style.display='none';overlayCenter.classList.remove('topRight');}
  startBtn.addEventListener('click',()=>{if(!STATE.running)startGame()}); tPlay.addEventListener('click',()=>{if(!STATE.running)startGame()});
  pauseBtn.addEventListener('click',togglePause); resetBtn.addEventListener('click',resetGame);

  let spawnTimer=0, laserCD=0, sparkT=0;
  function spawn(dt){spawnTimer-=dt;if(spawnTimer<=0&&STATE.mode==='play'){entities.push(Math.random()<SETTINGS.droneChance?new Drone():new Orb());if(entities.length>SETTINGS.max)entities.shift();spawnTimer=.6+Math.random()*.6}}

  // ===== win / lose =====
  const WIN_GOOD=["A watcher, a holy one","The heavens declare His glory","He numbers the stars by name","The morning stars sang together","Ministering spirits sent to serve","Luminaries do not transgress their order","Hosts of heaven worship Him","Signs in the heavens for seasons","Those who are wise shine","Let the righteous be glad"];
  let cinWin=null, cinLose=null;

  function startLoseCinematic(){
    sfx.lose();
    STATE.mode='cin_lose';
    overlay.style.display='none'; overlayCenter.classList.add('topRight');
    versesBox.innerHTML=''; againBtn.style.display='none';
    setTimeout(()=>{
      titleText.textContent='SPOTTED';
      versesBox.innerHTML='<p>The drones marked you.</p><p>Agents escorted you away.</p>';
      hintEl.textContent='Tap or press any key…';
      againBtn.style.display='inline-block'; againBtn.onclick=()=>resetGame();
      overlay.style.display='block';
    }, 400);
  }

  function buildEnochTargets(maxPts){
    const off=document.createElement('canvas'), w=720,h=720; off.width=w; off.height=h; const oc=off.getContext('2d');
    oc.clearRect(0,0,w,h); oc.fillStyle='#fff';
    const cx=w/2, base=h-22;

    // robe / body outline
    oc.beginPath();
    oc.moveTo(cx-56, 276);
    oc.quadraticCurveTo(cx-20, 260, cx, 260);
    oc.quadraticCurveTo(cx+20, 260, cx+56, 276);
    oc.bezierCurveTo(cx+152, 340, cx+180, 520, cx+180, base);
    oc.lineTo(cx-180, base);
    oc.bezierCurveTo(cx-180, 520, cx-152, 340, cx-56, 276);
    oc.closePath(); oc.fill();

    // head + beard mass
    oc.beginPath();
    oc.moveTo(cx, 128);
    oc.bezierCurveTo(cx-62, 148, cx-70, 198, cx-45, 230);
    oc.bezierCurveTo(cx-22, 246, cx-10, 252, cx, 254);
    oc.bezierCurveTo(cx+10, 252, cx+22, 246, cx+45, 230);
    oc.bezierCurveTo(cx+70, 198, cx+62, 148, cx, 128);
    oc.closePath(); oc.fill();

    // nose / beard point
    oc.beginPath(); oc.moveTo(cx-18, 248); oc.lineTo(cx+18, 248); oc.lineTo(cx, 304); oc.closePath(); oc.fill();
    // face ellipse
    oc.beginPath(); oc.ellipse(cx, 244, 28, 18, 0, 0, Math.PI*2); oc.fill();

    // arms
    oc.beginPath(); oc.moveTo(cx-48, 300); oc.bezierCurveTo(cx-150, 350, cx-150, 410, cx-70, 430); oc.lineTo(cx-48, 420); oc.closePath(); oc.fill();
    oc.beginPath(); oc.moveTo(cx+48, 300); oc.bezierCurveTo(cx+150, 350, cx+150, 410, cx+70, 430); oc.lineTo(cx+48, 420); oc.closePath(); oc.fill();

    // belt
    oc.fillRect(cx-82, 408, 164, 18);

    // staff (right hand) + orb tip
    const staffTopY=258, staffBaseY=base+10, staffX=cx+146;
    oc.fillRect(staffX-8, staffTopY, 16, staffBaseY-staffTopY);
    oc.beginPath(); oc.arc(staffX, staffTopY-22, 20, 0, Math.PI*2); oc.fill();
    const rawStaffTip={x:staffX, y:staffTopY-22};

    // book slab at left arm
    oc.save(); oc.translate(cx-126, 332); oc.rotate(-0.22); oc.fillRect(-52,-16,104,32); oc.restore();

    // carve openings: legs gap + robe folds
    oc.globalCompositeOperation='destination-out';
    oc.beginPath(); oc.moveTo(cx, base-2); oc.lineTo(cx-12, base-62); oc.lineTo(cx+12, base-62); oc.closePath(); oc.fill();
    oc.beginPath(); oc.ellipse(cx, 360, 44, 7, 0, 0, Math.PI*2); oc.fill();
    oc.beginPath(); oc.ellipse(cx, 288, 20, 6, 0, 0, Math.PI*2); oc.fill();
    oc.globalCompositeOperation='source-over';

    // sample points
    const stepBase=10, step=REDUCED_MOTION?stepBase+3:stepBase;
    const edges=[], fills=[];
    const img=oc.getImageData(0,0,w,h).data;
    const aAt=(x,y)=> (x<0||y<0||x>=w||y>=h)?0:img[(y*w+x)*4+3];
    for(let y=0;y<h;y+=step){
      for(let x=0;x<w;x+=step){
        const a=aAt(x,y);
        if(a>160){
          const e=aAt(x+step,y)<100||aAt(x-step,y)<100||aAt(x,y+step)<100||aAt(x,y-step)<100;
          const jitter = e ? 0 : (Math.random()-0.5)*step*0.35;
          (e?edges:fills).push({x:x+jitter,y:y-jitter,edge:e});
        }
      }
    }
    const edgeRatio = 0.70;
    const wantEdges=Math.min(edges.length,Math.floor(maxPts*edgeRatio));
    const wantFill=Math.min(fills.length,Math.max(0,maxPts-wantEdges));
    const chosen=shuffle(edges).slice(0,wantEdges).concat(shuffle(fills).slice(0,wantFill));

    const scale=(canvas.clientHeight*0.54)/h;
    const ox=canvas.clientWidth*0.5-(w*scale)/2;
    const oy=Math.max(6, canvas.clientHeight*0.02);

    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    for(const p of chosen){p.x=ox+p.x*scale;p.y=oy+p.y*scale; if(p.x<minX)minX=p.x; if(p.y<minY)minY=p.y; if(p.x>maxX)maxX=p.x; if(p.y>maxY)maxY=p.y; }

    const staffTip = { x: ox + rawStaffTip.x*scale, y: oy + rawStaffTip.y*scale };
    const center = { x:(minX+maxX)/2, y:(minY+maxY)/2 };
    const radius = Math.max(maxX-minX, maxY-minY)/2;

    return { points: chosen, meta:{staffTip, center, radius} };

    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]]}return a}
  }

  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]]}return a}
  function randomSubset(arr,n){const s=shuffle([...arr]);return s.slice(0,Math.max(0,Math.min(n,s.length)))}

  function startWinCinematic(){
    sfx.win();
    STATE.mode='cin_win';
    overlay.style.display='block'; overlayCenter.classList.remove('topRight');
    versesBox.innerHTML=''; titleText.textContent='ENOCH';  againBtn.style.display='none';

    const area = canvas.clientWidth*canvas.clientHeight;
    const baseCap = Math.floor(area/6500);
    const DOT_LIMIT = REDUCED_MOTION ? Math.min(320, Math.max(220, baseCap)) :
                      Math.min(1200, Math.max(500, baseCap));

    const orbStarts = [];
    for(const e of entities){ if(e.kind==='orb') orbStarts.push({x:e.x,y:e.y}); }
    entities.length=0; particles.length=0;

    const built = buildEnochTargets(DOT_LIMIT);
    const targets = built.points;
    const sources = shuffle(orbStarts).slice(0, targets.length);
    const need = Math.max(0, targets.length - sources.length);
    for(let i=0;i<need;i++){
      sources.push({x:rand(10,canvas.clientWidth-10), y:rand(10,canvas.clientHeight*0.5)});
    }

    const shuffledTargets = shuffle(targets);
    const dots=[];
    for(let i=0;i<shuffledTargets.length;i++){
      const s=sources[i], t=shuffledTargets[i];
      const dur = REDUCED_MOTION ? rand(1.0,1.5) : rand(1.4,2.2);
      dots.push({x:s.x,y:s.y, sx:s.x, sy:s.y, tx:t.x,ty:t.y, t:0,dur, edge:t.edge});
    }

    const versesThisRun = randomSubset(WIN_GOOD, REDUCED_MOTION ? 3 : 4);
    versesBox.innerHTML=''; 

    cinWin = {
      t:0, phase:0, done:false, fastForward:false,
      dots, verses:versesThisRun,
      showVerseIdx:-1, verseTimer:0.25, holdTimer:0.8,
      meta: built.meta
    };

    window.addEventListener('keydown',skipOnce,{once:true});
    window.addEventListener('mousedown',skipOnce,{once:true});
    window.addEventListener('touchstart',skipOnce,{once:true});
  }

  function skipOnce(){ if(cinWin && !cinWin.done){ 
    cinWin.dots.forEach(d=>{d.x=d.tx; d.y=d.ty; d.t=d.dur;});
    cinWin.phase=2; cinWin.showVerseIdx=-1; cinWin.verseTimer=0.1;
  }}

  function addLine(line){const p=document.createElement('p');p.textContent=line;p.style.margin='6px 0';p.style.opacity='0';p.style.transition='opacity 600ms ease';versesBox.appendChild(p);requestAnimationFrame(()=>p.style.opacity='1')}

  function updateWinCinematic(dt){
    if(!cinWin) return;
    const C=cinWin; C.t+=dt;

    if(C.phase===0){
      for(const d of C.dots){
        d.t=Math.min(d.dur,d.t+dt);
        const k=easeInOut(d.t/d.dur);
        d.x = d.sx + (d.tx - d.sx) * k;
        d.y = d.sy + (d.ty - d.sy) * k;
      }
      const allIn=C.dots.every(d=>d.t>=d.dur*0.98);
      if(allIn || C.t>6.0){ C.phase=1; C.t=0; }
    } else if(C.phase===1){
      C.holdTimer-=dt; if(C.holdTimer<=0){ C.phase=2; C.t=0; C.showVerseIdx=-1; C.verseTimer=0.25; versesBox.innerHTML=''; }
    } else if(C.phase===2){
      C.verseTimer-=dt;
      if(C.verseTimer<=0){
        C.showVerseIdx++;
        if(C.showVerseIdx < C.verses.length){
          addLine(C.verses[C.showVerseIdx]);
          C.verseTimer = REDUCED_MOTION ? 2.0 : 2.6;
        }else{
          againBtn.style.display='inline-block';
          againBtn.onclick=()=>{ resetGame(); };
          C.done=true;
        }
      }
    }
  }

  function drawWinCinematic(){
    if(!cinWin) return; const C=cinWin;

    // halo
    if(C.meta){
      const r=C.meta.radius*1.35, a=0.10+0.05*Math.sin(C.t*1.4);
      const {x,y}=C.meta.center;
      ctx.save();
      const g=ctx.createRadialGradient(x,y,r*0.25,x,y,r);
      g.addColorStop(0,`rgba(180,220,255,${0.10+a})`);
      g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.globalCompositeOperation='lighter';
      ctx.fillStyle=g; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
      ctx.restore();
    }

    // dots
    const pulse = 0.24 + 0.10*Math.sin(C.t*1.2);
    ctx.save(); ctx.globalCompositeOperation='lighter';
    ctx.fillStyle='rgba(235,250,255,0.95)'; ctx.beginPath();
    for(const d of C.dots){ ctx.moveTo(d.x+1.5,d.y); ctx.arc(d.x,d.y,d.edge?1.9:1.5,0,Math.PI*2); }
    ctx.fill();
    for(const d of C.dots){ // glow
      const r = d.edge?7.0:5.4;
      const a = 0.62+pulse;
      const g=ctx.createRadialGradient(d.x,d.y,r*0.25,d.x,d.y,r);
      g.addColorStop(0,`rgba(140,220,255,${a})`);
      g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(d.x,d.y,r,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();

    // staff tip twinkle
    if(C.meta && C.meta.staffTip){
      const s=C.meta.staffTip, tw=1+0.6*Math.sin(C.t*8);
      const g=ctx.createRadialGradient(s.x,s.y,2,s.x,s.y,9+tw*2);
      g.addColorStop(0,'rgba(200,240,255,0.9)'); g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.save(); ctx.globalCompositeOperation='lighter';
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s.x,s.y,9+tw*2,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }

    overlay.style.pointerEvents='none'; overlay.style.display='block';
    titleText.textContent='ENOCH';
  }

  // ===== update/render main =====
  function update(dt){
    if(!STATE.running || STATE.paused) return;
    STATE.t += dt;
    if(STATE.mode==='play'){
      STATE.timeLeft=Math.max(0,STATE.timeLeft-dt);
      if(STATE.timeLeft===0){ STATE.ended=true; (STATE.score>=SETTINGS.goal?startWinCinematic:startLoseCinematic)(); return; }
      player.y=player.feetY-player.h; player.x=(canvas.clientWidth-player.w)/2;
      spawn(dt); entities.forEach(e=>e.update(dt));
      for(let i=particles.length-1;i>=0;i--){particles[i].update(dt); if(particles[i].life<=0) particles.splice(i,1);}

      // laser
      laserCD=Math.max(0,laserCD-dt); sparkT-=dt;
      if(input.aiming){
        const sx=player.hand.x, sy=player.hand.y, tx=input.pointer.x, ty=input.pointer.y;
        if(sparkT<=0 && !REDUCED_MOTION){
          sparkT=.03; for(let i=0;i<4;i++){ const t=i/5; const lx=sx+(tx-sx)*t+rand(-1,1), ly=sy+(ty-sy)*t+rand(-1,1); particles.push(new Particle(lx,ly,0,0,.14,[120,255,200],[0,255,120],1.2)); }
        }
        let best=null,bestD2=1e12;
        for(const e of entities){ if(!e.alive)continue; const c=e.getCircle(); if(lineHitsCircle(sx,sy,tx,ty,c.x,c.y,c.r)){ const dx=c.x-sx,dy=c.y-sy,d2=dx*dx+dy*dy; if(d2<bestD2){best=e;bestD2=d2} } }
        if(laserCD<=0 && best){
          const c=best.getCircle();
          for(let i=0;i<12;i++){ const a=Math.random()*Math.PI*2, sp=rand(60,180); const col=best.kind==='orb'?[190,255,255]:[255,140,120]; const glow=best.kind==='orb'?[140,220,255]:[255,60,60]; particles.push(new Particle(c.x,c.y,Math.cos(a)*sp,Math.sin(a)*sp,0.35,col,glow,1.8)); }
          if(best.kind==='orb'){ STATE.hits++;STATE.streak++;STATE.score+=100+Math.max(0,STATE.streak-2)*25; best.alive=false; sfx.orb(); }
          else { STATE.misses++;STATE.streak=0;STATE.score-=150; sfx.drone(); }
          laserCD=.12;
        }
      }
    } else if(STATE.mode==='cin_win'){ updateWinCinematic(dt); }
  }

  function draw(){
    ctx.drawImage(bgImg,0,0,canvas.clientWidth,canvas.clientHeight);

    if(STATE.mode==='play'){
      entities.forEach(e=>e.draw(ctx));
      drawPlayer();
      if(input.aiming){
        const sx=player.hand.x, sy=player.hand.y, tx=input.pointer.x, ty=input.pointer.y;
        ctx.save(); ctx.globalCompositeOperation='lighter';
        const px=Math.min((window.devicePixelRatio||1),2.5);
        ctx.strokeStyle='rgba(0,255,120,.9)'; ctx.lineWidth=2.0*px; ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(tx,ty); ctx.stroke();
        ctx.strokeStyle='rgba(120,255,200,.25)'; ctx.lineWidth=5.0*px; ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(tx,ty); ctx.stroke();
        ctx.restore();
      }
      for(const p of particles) p.draw(ctx);
    } else if(STATE.mode==='cin_win'){
      drawWinCinematic();
    }

    // HUD
    scoreEl.textContent=STATE.score;
    timeEl.textContent=STATE.timeLeft.toFixed(1);
    hitsEl.textContent=STATE.hits;
    missesEl.textContent=STATE.misses;
  }

  function loop(t){const n=t||performance.now(),dt=Math.min(.033,(n-(STATE.last||n))/1000);STATE.last=n;update(dt);draw();requestAnimationFrame(loop)}
  requestAnimationFrame(loop);

  // show start
  titleEl.style.display='flex';
})();
</script>
</body>
</html>
